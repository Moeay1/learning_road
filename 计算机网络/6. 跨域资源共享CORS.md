## 跨域资源共享(CORS)

####  简介

> 跨域资源共享(CORS)是一种机制，它使用额外的HTTP头来告诉浏览器让运行在一个origin(domain)上的web应用被准许访问来自不同源服务器上的指定的资源。
>
> 当一个资源从与该资源本身所在的服务器**不同的域、协议或端口**请求一个资源时，资源会发起**跨域HTTP请求**。
>
> 出于安全原因，浏览器限制从脚本内发起的跨域HTTP请求。例如，`XMLHttpRequest`和`Fetch API`遵循同源策略。这意味着使用这些API的Web应用程序只能从加载应用程序的同一个域请求HTTP资源，除非响应报文包含了正确CORS响应头。
>
> 注：并不一定是浏览器限制了发起跨域请求，也可能是跨域请求可以正常发起，但是返回响应被浏览器拦截了。

#### 概述

> 跨域资源共享标准新增了一组HTTP首部字段，允许服务器声明哪些源站通过浏览器有权限访问哪些资源。
>
> 规范要求：
>
> 对那些可能对服务器数据产生副作用的HTTP请求方法（特别是GET以外的HTTP请求，或者搭配某些MIME类型的POST请求），浏览器会首先使用`OPTIONS`方法发起一个预检请求（preflight request)，从而获知服务端是否允许该跨域请求。
>
> 服务器确认允许之后，才发起实际的HTTP请求。
>
> 在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证(包括`Cookies和HTTP`认证相关数据)
>
> 注意：`CORS`请求失败会产生错误，但为了安全，在`JS`代码层面无法获知具体哪里出了问题。只能通过浏览器控制台得知具体哪里出现了错误。

#### 简单请求

> 某些请求不会触发`CORS`预检请求. 称之为"简单请求".
>
> 满足下述**所有**条件的视为"简单请求":
>
> - 使用下列请求方法:
>   - GET
>   - HEAD
>   - POST
> - 规范定义了对`CORS`安全的首部字段集合, 不得人为设置该集合之外的其他首部字段. 该集合为:
>   - `Accept`
>   - `Accept-Language`
>   - `Content-Language`
>   - `Content-Type`(类型同样有限制)
> - `Content-Type`值仅限于下列三者之一:
>   - `text/plain`
>   - `multipart/form-data`
>   - `application/x-www-form-urlencoded`
>
> 凡是不同时满足上面两个条件,就属于"非简单请求".
>
> 比如说，假如站点 `http://foo.example` 的网页应用想要访问 `http://bar.other` 的资源。`http://foo.example` 的网页中可能包含类似于下面的 JavaScript 代码：
>
> ```
> var invocation = new XMLHttpRequest();
> var url = 'http://bar.other/resources/public-data/';
>    
> function callOtherDomain() {
>   if(invocation) {    
>     invocation.open('GET', url, true);
>     invocation.onreadystatechange = handler;
>     invocation.send(); 
>   }
> }
> ```
>
> 客户端与服务器之间使用`CORS`首部字段来处理跨域权限:
>
> ![](https://mdn.mozillademos.org/files/14293/simple_req.png)
>
> 请求报文和响应报文如下:
>
> ```
> GET /resources/public-data/ HTTP/1.1
> Host: bar.other
> User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre
> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
> Accept-Language: en-us,en;q=0.5
> Accept-Encoding: gzip,deflate
> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
> Connection: keep-alive
> Referer: http://foo.example/examples/access-control/simpleXSInvocation.html
> Origin: http://foo.example
> 
> 
> HTTP/1.1 200 OK
> Date: Mon, 01 Dec 2008 00:23:53 GMT
> Server: Apache/2.0.61 
> Access-Control-Allow-Origin: *
> Keep-Alive: timeout=2, max=100
> Connection: Keep-Alive
> Transfer-Encoding: chunked
> Content-Type: application/xml
> ```
>
> 